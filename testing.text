from flask import Flask, request, jsonify, send_from_directory
from flask_cors import CORS
import yt_dlp as youtube_dl
import os
from werkzeug.utils import secure_filename

# Create downloads folder if it doesn't exist
os.makedirs("downloads", exist_ok=True)

app = Flask(__name__)
CORS(app)

@app.route('/download', methods=['POST'])
def download_video():
    data = request.get_json()
    video_url = data.get('video_url')

    if not video_url:
        return jsonify({"success": False, "message": "No URL provided"}), 400

    try:
        # First, get video info without downloading to generate a safe filename
        ydl_opts_info = {'quiet': True, 'skip_download': True}
        with youtube_dl.YoutubeDL(ydl_opts_info) as ydl:
            info_dict = ydl.extract_info(video_url, download=False)
            title = info_dict.get('title', 'video')
            ext = info_dict.get('ext', 'mp4')  # fallback
            filename = secure_filename(f"{title}.{ext}")

        # Now, download the video using safe filename
        ydl_opts_download = {
            'format': 'best',
            'outtmpl': f'downloads/{filename}',
            'noplaylist': True
        }
        with youtube_dl.YoutubeDL(ydl_opts_download) as ydl:
            ydl.download([video_url])

        return jsonify({
            "success": True,
            "download_url": f"http://127.0.0.1:5000/downloads/{filename}"
        })

    except Exception as e:
        return jsonify({"success": False, "message": str(e)}), 500

# Serve the file from the downloads folder
@app.route('/downloads/<path:filename>')
def serve_file(filename):
    return send_from_directory('downloads', filename)

if __name__ == '__main__':
    app.run(debug=True)


@app.route('/download', methods=['POST'])
def download_video():
    data = request.get_json()
    print("Received request:", data)

    video_url = data.get('video_url')
    if not video_url:
        return jsonify({"success": False, "message": "No video URL provided"}), 400

    try:
        ydl_opts = {
            'format': 'best',
            'outtmpl': 'downloads/%(title)s.%(ext)s',
            'noplaylist': True,
        }

        print("Downloading video...")
        with youtube_dl.YoutubeDL(ydl_opts) as ydl:
            info_dict = ydl.extract_info(video_url, download=True)
            video_title = info_dict.get('title', 'default')
            print("Video downloaded:", video_title)

        file_path = f"/downloads/{video_title}.mp4"
        return jsonify({"success": True, "download_url": file_path})

    except Exception as e:
        print("Download error:", str(e))
        return jsonify({"success": False, "message": str(e)}), 500

